<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Результаты исследования - AI Research Assistant</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <!-- Animated Background -->
        <div class="background-animation">
            <div class="gradient-orb orb-1"></div>
            <div class="gradient-orb orb-2"></div>
            <div class="gradient-orb orb-3"></div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="results-container">
                <!-- Header -->
                <div class="results-header">
                    <div class="success-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h1 class="results-title">Отчет готов!</h1>
                    <p class="results-subtitle">
                        ИИ-ассистент завершил анализ и подготовил детальный отчет
                    </p>
                </div>

                <!-- Action Buttons -->
                <div class="results-actions">
                    <button class="action-btn export-btn" onclick="exportToPDF()">
                        <i class="fas fa-download"></i>
                        Экспорт в PDF
                    </button>
                    <button class="action-btn copy-btn" onclick="copyToClipboard()">
                        <i class="fas fa-copy"></i>
                        Копировать текст
                    </button>
                    <button class="action-btn new-research-btn" onclick="startNewResearch()">
                        <i class="fas fa-plus"></i>
                        Новое исследование
                    </button>
                </div>

                <!-- Report Content -->
                <div class="report-content" id="report-content">
                    {% if report %}
                        {{ report | safe }}
                    {% else %}
                        <div class="no-report">
                            <i class="fas fa-exclamation-triangle"></i>
                            <h3>Отчет не найден</h3>
                            <p>Попробуйте сгенерировать отчет заново</p>
                            <button class="action-btn" onclick="window.location.href='/'">
                                <i class="fas fa-home"></i>
                                На главную
                            </button>
                        </div>
                    {% endif %}
                </div>

                <!-- Report Stats -->
                <div class="report-stats">
                    <div class="stat-item">
                        <i class="fas fa-chart-bar"></i>
                        <div>
                            <strong>Кейсы найдены</strong>
                            <span id="cases-count">10+</span>
                        </div>
                    </div>
                    <div class="stat-item">
                        <i class="fas fa-globe"></i>
                        <div>
                            <strong>Страны</strong>
                            <span id="countries-count">15+</span>
                        </div>
                    </div>
                    <div class="stat-item">
                        <i class="fas fa-link"></i>
                        <div>
                            <strong>Источники</strong>
                            <span id="sources-count">50+</span>
                        </div>
                    </div>
                    <div class="stat-item">
                        <i class="fas fa-clock"></i>
                        <div>
                            <strong>Время анализа</strong>
                            <span id="analysis-time">2-3 мин</span>
                        </div>
                    </div>
                </div>

                <!-- Additional Actions -->
                <div class="additional-actions">
                    <h3>Дополнительные действия:</h3>
                    <div class="action-grid">
                        <button class="secondary-btn" onclick="shareReport()">
                            <i class="fas fa-share"></i>
                            Поделиться
                        </button>
                        <button class="secondary-btn" onclick="printReport()">
                            <i class="fas fa-print"></i>
                            Печать
                        </button>
                        <button class="secondary-btn" onclick="saveToFavorites()">
                            <i class="fas fa-bookmark"></i>
                            Сохранить
                        </button>
                        <button class="secondary-btn" onclick="sendToEmail()">
                            <i class="fas fa-envelope"></i>
                            Отправить
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Format report content
            formatReportContent();
            
            // Parse report content to extract stats
            parseReportStats();
        });

        function formatReportContent() {
            const reportContent = document.getElementById('report-content');
            if (!reportContent) return;

            let content = reportContent.innerHTML;
            
            // Helper function to format cell content
            function formatCellContent(cell) {
                if (!cell) return '';
                
                let formatted = cell
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/^•\s*(.+)$/gm, '<li>$1</li>')
                    .replace(/^(\d+)\.\s*(.+)$/gm, '<li>$2</li>');
                
                // If contains list items, wrap in ul
                if (formatted.includes('<li>')) {
                    formatted = formatted.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
                }
                
                return formatted;
            }
            
            // Convert Markdown to HTML
            content = content
                // Remove paragraphs with only dashes
                .replace(/---/g, '')
                .replace(/\s*---\s*/g, '')
                // Headers
                .replace(/^#### (.*$)/gim, '<h4>$1</h4>')
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                // Bold text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                // Italic text
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                // Links - improved formatting (avoid double processing)
                .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer" class="source-link">$1</a>')
                .replace(/(?<!href=")(https?:\/\/[^\s<>"]+)(?![^<]*<\/a>)/g, '<a href="$1" target="_blank" rel="noopener noreferrer" class="source-link">$1</a>')
                // Tables - improved algorithm to group related rows and avoid empty cells
                .replace(/(.*\|.*\n)+/g, function(match) {
                    const lines = match.trim().split('\n').filter(line => line.trim());
                    if (lines.length < 2) return match;
                    
                    // Check if it's actually a table (has multiple lines with |)
                    const hasMultipleTableLines = lines.filter(line => line.includes('|')).length >= 2;
                    if (!hasMultipleTableLines) return match;
                    
                    let table = '<div class="table-wrapper"><table class="report-table">';
                    let currentRow = null;
                    let isFirstRow = true;
                    
                    // Process each line
                    lines.forEach((line, index) => {
                        if (line.trim() && line.includes('|')) {
                            const cells = line.split('|').map(cell => cell.trim());
                            
                            // Filter out empty cells and dash separators
                            const filteredCells = cells.filter(cell => 
                                cell && 
                                !cell.match(/^-+$/) && 
                                cell.trim().length > 0
                            );
                            
                            if (filteredCells.length === 0) return;
                            
                            // Check if first cell is a sub-point (starts with • or -)
                            const firstCell = filteredCells[0];
                            const isSubPoint = firstCell.startsWith('•') || firstCell.startsWith('-');
                            
                            if (isFirstRow) {
                                // Header row
                                table += '<thead><tr>';
                                filteredCells.forEach(cell => {
                                    table += `<th>${cell}</th>`;
                                });
                                table += '</tr></thead><tbody>';
                                isFirstRow = false;
                            } else if (isSubPoint && currentRow) {
                                // This is a sub-point - merge with previous row
                                const lastRowEnd = table.lastIndexOf('</tr>');
                                if (lastRowEnd > 0) {
                                    const rowStart = table.lastIndexOf('<tr>', lastRowEnd);
                                    const rowContent = table.substring(rowStart, lastRowEnd);
                                    
                                    // Find the last cell and append content
                                    const lastCellEnd = rowContent.lastIndexOf('</td>');
                                    if (lastCellEnd > 0) {
                                        const cellStart = rowContent.lastIndexOf('<td>', lastCellEnd);
                                        const cellContent = rowContent.substring(cellStart + 4, lastCellEnd);
                                        
                                        // Add sub-point content to the last cell
                                        const subPointContent = filteredCells.slice(1).join(' | ');
                                        if (subPointContent.trim()) {
                                            const newCellContent = cellContent + '<br/>' + formatCellContent(subPointContent);
                                            const newRowContent = rowContent.substring(0, cellStart + 4) + newCellContent + rowContent.substring(lastCellEnd);
                                            table = table.substring(0, rowStart) + newRowContent + table.substring(lastRowEnd);
                                        }
                                    }
                                }
                            } else {
                                // New data row
                                currentRow = filteredCells;
                                table += '<tr>';
                                filteredCells.forEach(cell => {
                                    table += `<td>${formatCellContent(cell)}</td>`;
                                });
                                table += '</tr>';
                            }
                        }
                    });
                    
                    table += '</tbody></table></div>';
                    return table;
                })
                // Lists
                .replace(/^- (.*$)/gim, '<li>$1</li>')
                .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>')
                // Line breaks
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>')
                // Wrap in paragraphs
                .replace(/^(?!<[h|u|o|l|t])/gm, '<p>')
                .replace(/(?<!>)$/gm, '</p>');

            reportContent.innerHTML = content;
        }

        function parseReportStats() {
            const reportContent = document.getElementById('report-content');
            if (!reportContent) return;

            const text = reportContent.innerText;
            
            // Count cases (rough estimation)
            const caseMatches = text.match(/кейс|case|пример/gi);
            const casesCount = caseMatches ? caseMatches.length : 10;
            document.getElementById('cases-count').textContent = casesCount + '+';

            // Count countries (rough estimation)
            const countryMatches = text.match(/страна|country|государство/gi);
            const countriesCount = countryMatches ? Math.min(countryMatches.length, 20) : 15;
            document.getElementById('countries-count').textContent = countriesCount + '+';

            // Count sources (rough estimation)
            const sourceMatches = text.match(/http|www\.|\.com|\.ru|источник/gi);
            const sourcesCount = sourceMatches ? Math.min(sourceMatches.length, 50) : 30;
            document.getElementById('sources-count').textContent = sourcesCount + '+';
        }

        function exportToPDF() {
            const exportBtn = document.querySelector('.export-btn');
            if (exportBtn) {
                exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Экспорт...';
                exportBtn.disabled = true;
            }

            // Get report content
            const reportContent = document.getElementById('report-content').innerHTML;
            
            // Create a new window for PDF generation
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Research Report</title>
                    <meta charset="UTF-8">
                    <style>
                        body { 
                            font-family: 'Inter', Arial, sans-serif; 
                            margin: 0; 
                            padding: 20px; 
                            line-height: 1.6; 
                            color: #333;
                            background: white;
                        }
                        .report-header { 
                            text-align: center; 
                            margin-bottom: 40px;
                            border-bottom: 3px solid #667eea;
                            padding-bottom: 20px;
                        }
                        .report-header h1 {
                            color: #333;
                            font-size: 2.5rem;
                            margin-bottom: 10px;
                        }
                        .report-header p {
                            color: #666;
                            font-size: 1.1rem;
                        }
                        .report-content { 
                            margin-top: 20px; 
                        }
                        h1, h2, h3, h4 {
                            color: #333;
                            margin-top: 30px;
                            margin-bottom: 15px;
                            font-weight: 600;
                        }
                        h1 {
                            font-size: 2rem;
                            border-bottom: 3px solid #667eea;
                            padding-bottom: 10px;
                        }
                        h2 {
                            font-size: 1.5rem;
                            color: #667eea;
                        }
                        h3 {
                            font-size: 1.3rem;
                            color: #555;
                        }
                        h4 {
                            font-size: 1.1rem;
                            color: #666;
                        }
                        p {
                            margin-bottom: 15px;
                            text-align: justify;
                        }
                        ul, ol {
                            margin: 15px 0;
                            padding-left: 30px;
                        }
                        li {
                            margin-bottom: 8px;
                        }
                        strong {
                            color: #333;
                            font-weight: 600;
                        }
                        em {
                            color: #667eea;
                            font-style: italic;
                        }
                        blockquote {
                            border-left: 4px solid #667eea;
                            padding-left: 20px;
                            margin: 20px 0;
                            background: rgba(102, 126, 234, 0.05);
                            padding: 15px 20px;
                            border-radius: 0 10px 10px 0;
                        }
                        code {
                            background: rgba(102, 126, 234, 0.1);
                            padding: 2px 6px;
                            border-radius: 4px;
                            font-family: 'Courier New', monospace;
                            font-size: 0.9rem;
                        }
                        pre {
                            background: #f8f9fa;
                            padding: 20px;
                            border-radius: 10px;
                            overflow-x: auto;
                            border: 1px solid #e1e5e9;
                        }
                        table,
                        .report-table {
                            width: 100%;
                            border-collapse: collapse;
                            margin: 25px 0;
                            background: white;
                            border-radius: 12px;
                            overflow: hidden;
                            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
                            border: 1px solid #e1e5e9;
                        }
                        th, td {
                            border: 1px solid #e1e5e9;
                            padding: 18px 15px;
                            text-align: left;
                            vertical-align: top;
                            word-wrap: break-word;
                        }
                        th {
                            background: linear-gradient(135deg, #667eea, #764ba2);
                            color: white;
                            font-weight: 700;
                            font-size: 0.9rem;
                            text-transform: uppercase;
                            letter-spacing: 0.8px;
                            text-align: center;
                        }
                        td {
                            background: #ffffff;
                            font-size: 0.9rem;
                            line-height: 1.6;
                            color: #333;
                        }
                        tr:nth-child(even) td {
                            background: #f8f9fa;
                        }
                        td ul {
                            margin: 8px 0;
                            padding-left: 20px;
                        }
                        td li {
                            margin-bottom: 6px;
                            line-height: 1.5;
                        }
                        td strong {
                            color: #667eea;
                            font-weight: 600;
                        }
                        td em {
                            color: #666;
                            font-style: italic;
                        }
                        hr {
                            border: none;
                            height: 2px;
                            background: linear-gradient(90deg, transparent, #667eea, transparent);
                            margin: 30px 0;
                        }
                        @media print {
                            body { margin: 0; }
                            .report-header { page-break-after: avoid; }
                            h1, h2, h3 { page-break-after: avoid; }
                        }
                    </style>
                </head>
                <body>
                    <div class="report-header">
                        <h1>Отчет по продуктовому исследованию</h1>
                        <p>Сгенерировано: ${new Date().toLocaleDateString('ru-RU')}</p>
                    </div>
                    <div class="report-content">
                        ${reportContent}
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.print();

            // Reset button
            if (exportBtn) {
                setTimeout(() => {
                    exportBtn.innerHTML = '<i class="fas fa-download"></i> Экспорт в PDF';
                    exportBtn.disabled = false;
                }, 2000);
            }
        }

        function copyToClipboard() {
            const reportContent = document.getElementById('report-content');
            if (!reportContent) return;

            const text = reportContent.innerText;
            navigator.clipboard.writeText(text).then(() => {
                const copyBtn = document.querySelector('.copy-btn');
                if (copyBtn) {
                    const originalText = copyBtn.innerHTML;
                    copyBtn.innerHTML = '<i class="fas fa-check"></i> Скопировано!';
                    setTimeout(() => {
                        copyBtn.innerHTML = originalText;
                    }, 2000);
                }
            }).catch(err => {
                console.error('Failed to copy: ', err);
                alert('Не удалось скопировать текст');
            });
        }

        function startNewResearch() {
            if (confirm('Начать новое исследование? Текущий отчет будет потерян.')) {
                window.location.href = '/';
            }
        }

        function shareReport() {
            if (navigator.share) {
                navigator.share({
                    title: 'Отчет по продуктовому исследованию',
                    text: 'Посмотрите на результаты анализа рынка',
                    url: window.location.href
                });
            } else {
                // Fallback: copy URL to clipboard
                navigator.clipboard.writeText(window.location.href).then(() => {
                    alert('Ссылка скопирована в буфер обмена');
                });
            }
        }

        function printReport() {
            window.print();
        }

        function saveToFavorites() {
            // This would typically save to localStorage or send to backend
            alert('Функция сохранения будет реализована в следующих версиях');
        }

        function sendToEmail() {
            const email = prompt('Введите email для отправки отчета:');
            if (email && email.includes('@')) {
                alert('Отчет будет отправлен на ' + email);
                // Here you would typically send the report via email
            }
        }

        // Add smooth scrolling for long reports
        function scrollToSection(sectionId) {
            const element = document.getElementById(sectionId);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth' });
            }
        }

        // Add table of contents functionality
        function generateTableOfContents() {
            const reportContent = document.getElementById('report-content');
            if (!reportContent) return;

            const headings = reportContent.querySelectorAll('h1, h2, h3');
            if (headings.length === 0) return;

            const toc = document.createElement('div');
            toc.className = 'table-of-contents';
            toc.innerHTML = '<h3>Содержание:</h3><ul></ul>';

            const tocList = toc.querySelector('ul');
            
            headings.forEach((heading, index) => {
                const id = `heading-${index}`;
                heading.id = id;
                
                const li = document.createElement('li');
                li.innerHTML = `<a href="#${id}">${heading.textContent}</a>`;
                tocList.appendChild(li);
            });

            reportContent.insertBefore(toc, reportContent.firstChild);
        }

        // Initialize table of contents
        document.addEventListener('DOMContentLoaded', generateTableOfContents);
    </script>

    <style>
        .success-icon {
            font-size: 4rem;
            color: #28a745;
            margin-bottom: 20px;
            animation: bounce 1s ease-in-out;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }

        .results-subtitle {
            color: #666;
            font-size: 1.2rem;
            margin-bottom: 30px;
        }

        .report-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 40px 0;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 15px;
            transition: all 0.3s ease;
        }

        .stat-item:hover {
            background: rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
        }

        .stat-item i {
            font-size: 2rem;
            color: #667eea;
        }

        .stat-item strong {
            display: block;
            color: #333;
            font-size: 0.9rem;
        }

        .stat-item span {
            color: #667eea;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .additional-actions {
            margin-top: 40px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 20px;
        }

        .additional-actions h3 {
            margin-bottom: 20px;
            color: #333;
        }

        .action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .secondary-btn {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            border: 2px solid rgba(102, 126, 234, 0.3);
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }

        .secondary-btn:hover {
            background: rgba(102, 126, 234, 0.2);
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .no-report {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .no-report i {
            font-size: 3rem;
            color: #ffc107;
            margin-bottom: 20px;
        }

        .no-report h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .table-of-contents {
            background: rgba(102, 126, 234, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .table-of-contents h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .table-of-contents ul {
            list-style: none;
            padding: 0;
        }

        .table-of-contents li {
            margin-bottom: 8px;
        }

        .table-of-contents a {
            color: #667eea;
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .table-of-contents a:hover {
            color: #764ba2;
        }

        @media (max-width: 768px) {
            .results-actions {
                flex-direction: column;
            }
            
            .report-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .action-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media print {
            .background-animation,
            .results-actions,
            .report-stats,
            .additional-actions {
                display: none;
            }
            
            .main-content {
                background: white;
                box-shadow: none;
            }
        }
    </style>
</body>
</html>
